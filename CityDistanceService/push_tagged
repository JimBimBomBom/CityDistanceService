#!/bin/bash

# Step 1: Parse the command line argument for the message
for arg in "$@"
do
    case $arg in
        -msg)
        MESSAGE="$2"
        shift # Remove -msg from processing
        shift # Remove the actual message from processing
        ;;
        *)
        shift # Remove generic argument from processing
        ;;
    esac
done

# Check if message is empty
if [ -z "$MESSAGE" ]; then
    echo "Message is required. Use -msg to specify the commit message."
    exit 1
fi

# Step 2: Extract the version
VERSION=$(grep -oP 'Version\s*=\s*"\K[^"]*' ./src/Constants.cs)

if [ -z "$VERSION" ]; then
    echo "Version could not be extracted from ./src/Constants.cs"
    exit 1
fi

# Step 3: Execute the Git commands
git add -A
git commit -m "$MESSAGE"
git tag -d "$VERSION"
git tag "$VERSION"
git push origin :refs/tags/"$VERSION"
git push origin "$VERSION"